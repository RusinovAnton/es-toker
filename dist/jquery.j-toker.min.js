/*! j-toker - v0.0.10-beta1 - 2017-10-16
* Copyright (c) 2017 Lynn Dylan Hurley; Licensed WTFPL */
!function(a){var b=Function("return this")();"function"==typeof define&&define.amd?define([b,"jquery","jquery-deparam","pubsub-js","jquery.cookie"],a):"object"==typeof exports?module.exports=a(b,require("jquery"),require("jquery-deparam"),require("pubsub-js"),require("jquery.cookie")):a(b,jQuery,b.deparam,b.PubSub)}(function(a,b,c,d){if(a.auth)return a.auth;var e=a.navigator,f="default",g="currentConfigName",h="authHeaders",i="auth.validation.success",j="auth.validation.error",k="auth.oAuthSignIn.error",l="auth.signIn.success",m="auth.signIn.error",n=function(){this.configured=!1,this.configs={},this.defaultConfigKey=null,this.firstTimeLogin=!1,this.mustResetPassword=!1,this.user={},this.oAuthDfd=null,this.oAuthTimer=null,this.configBase={apiUrl:"/api",signOutPath:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",accountUpdatePath:"/auth",accountDeletePath:"/auth",passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",validateOnPageLoad:!1,forceHardRedirect:!1,storage:"cookies",cookieExpiry:14,cookiePath:"/",passwordResetSuccessUrl:function(){return a.location.href},confirmationSuccessUrl:function(){return a.location.href},tokenFormat:{"access-token":"{{ access-token }}","token-type":"Bearer",client:"{{ client }}",expiry:"{{ expiry }}",uid:"{{ uid }}"},parseExpiry:function(a){return 1e3*parseInt(a.expiry,10)||null},handleLoginResponse:function(a){return a.data},handleAccountUpdateResponse:function(a){return a.data},handleTokenValidationResponse:function(a){return a.data},authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}}};n.prototype.reset=function(){this.destroySession(),this.configs={},this.defaultConfigKey=null,this.configured=!1,this.mustResetPassword=!1,this.firstTimeLogin=!1,this.oAuthDfd=null,this.oAuthTimer&&(clearTimeout(this.oAuthTimer),this.oAuthTimer=null);for(var c in this.user)delete this.user[c];b(document).unbind("ajaxComplete",this.updateAuthCredentials),a.removeEventListener&&a.removeEventListener("message",this.handlePostMessage),b.ajaxSetup({beforeSend:void 0})},n.prototype.invalidateTokens=function(){for(var a in this.user)delete this.user[a];this.deleteData(g),this.deleteData(h)},n.prototype.checkDependencies=function(){var e=[],f=[];if(!b)throw"jToker: jQuery not found. This module depends on jQuery.";if(a.localStorage||b.cookie||e.push("This browser does not support localStorage. You must install jquery-cookie to use jToker with this browser."),c||e.push("Dependency not met: jquery-deparam."),d||f.push("jquery.ba-tinypubsub.js not found. No auth events will be broadcast."),e.length)throw"jToker: Please resolve the following errors: "+e.join(" ");if(f.length&&console&&console.warn){var g=f.join(" ");console.warn("jToker: Warning: "+g)}},n.prototype.destroySession=function(){var c=[h,g];for(var d in c)if(d=c[d],a.localStorage&&a.localStorage.removeItem(d),b.cookie)for(var e in this.configs){var f=this.configs[e].cookiePath;b.removeCookie(d,{path:f})}},n.prototype.configure=function(c,d){if(d&&this.reset(),this.configured=!0,c||(c={}),c.constructor!==Array){this.defaultConfigKey=f;var e={};e[this.defaultConfigKey]=c,c=[e]}for(var g=0;g<c.length;g++){var h=o(c[g]);this.defaultConfigKey||(this.defaultConfigKey=h),this.configs[h]=b.extend({},this.configBase,c[g][h])}return this.checkDependencies(),b(document).ajaxComplete(a.auth.updateAuthCredentials),b.ajaxSetup({beforeSend:a.auth.appendAuthHeaders}),a.addEventListener&&a.addEventListener("message",this.handlePostMessage,!1),this.processSearchParams(),this.validateToken({config:this.getCurrentConfigName()})},n.prototype.getApiUrl=function(){var a=this.getConfig();return a.proxyIf()?a.proxyUrl:a.apiUrl},n.prototype.buildAuthHeaders=function(a){var b={},c=this.getConfig().tokenFormat;for(var d in c)b[d]=r(c[d],a);return b},n.prototype.setCurrentUser=function(a){for(var c in this.user)delete this.user[c];return b.extend(this.user,a),this.user.signedIn=!0,this.user.configName=this.getCurrentConfigName(),this.user},n.prototype.handlePostMessage=function(b){var c=!1;if("deliverCredentials"===b.data.message){delete b.data.message;var d=a.auth.normalizeTokenKeys(b.data),e=a.auth.buildAuthHeaders(d),f=a.auth.setCurrentUser(b.data);a.auth.persistData(h,e),a.auth.resolvePromise("auth.oAuthSignIn.success",a.auth.oAuthDfd,f),a.auth.broadcastEvent(l,f),a.auth.broadcastEvent(i,f),c=!0}"authFailure"===b.data.message&&(a.auth.rejectPromise(k,a.auth.oAuthDfd,b.data,"OAuth authentication failed."),a.auth.broadcastEvent(m,b.data),c=!0),c&&(clearTimeout(a.auth.oAuthTimer),a.auth.oAuthTimer=null)},n.prototype.normalizeTokenKeys=function(a){return a.token&&(a["access-token"]=a.token,delete a.token),a.auth_token&&(a["access-token"]=a.auth_token,delete a.auth_token),a.client_id&&(a.client=a.client_id,delete a.client_id),a.config&&(this.persistData(g,a.config,a.config),delete a.config),a},n.prototype.processSearchParams=function(){var a=this.getQs(),b=null;if(a=this.normalizeTokenKeys(a),a["access-token"]&&a.uid){b=this.buildAuthHeaders(a),this.persistData(h,b),a.reset_password&&(this.mustResetPassword=!0),a.account_confirmation_success&&(this.firstTimeLogin=!0);var c=this.getLocationWithoutParams(["access-token","token","auth_token","config","client","client_id","expiry","uid","reset_password","account_confirmation_success"]);this.setLocation(c)}return b},n.prototype.getLocationWithoutParams=function(c){var d=b.param(this.stripKeys(this.getSearchQs(),c)),e=b.param(this.stripKeys(this.getAnchorQs(),c)),f=a.location.hash.split("?")[0];return d&&(d="?"+d),e&&(f+="?"+e),f&&!f.match(/^#/)&&(f="#/"+f),a.location.protocol+"//"+a.location.host+a.location.pathname+d+f},n.prototype.stripKeys=function(a,b){for(var c in b)delete a[b[c]];return a},n.prototype.broadcastEvent=function(a,b){d.publish&&d.publish(a,b)},n.prototype.resolvePromise=function(a,b,c){var d=this;setTimeout(function(){d.broadcastEvent(a,c),b.resolve(c)},0)},n.prototype.rejectPromise=function(a,c,d,e){var f=this;d=b.parseJSON(d.responseText||"{}"),setTimeout(function(){f.broadcastEvent(a,d),c.reject({reason:e,data:d})},0)},n.prototype.validateToken=function(a){a||(a={});var c=b.Deferred();if(this.retrieveData(h)){var d=this.getConfig(a.config),e=this.getApiUrl()+d.tokenValidationPath;b.ajax({url:e,context:this,success:function(a){var b=d.handleTokenValidationResponse(a);this.setCurrentUser(b),this.firstTimeLogin&&this.broadcastEvent("auth.emailConfirmation.success",a),this.mustResetPassword&&this.broadcastEvent("auth.passwordResetConfirm.success",a),this.resolvePromise(i,c,this.user)},error:function(a){this.invalidateTokens(),this.firstTimeLogin&&this.broadcastEvent("auth.emailConfirmation.error",a),this.mustResetPassword&&this.broadcastEvent("auth.passwordResetConfirm.error",a),this.rejectPromise(j,c,a,"Cannot validate token; token rejected by server.")}})}else this.invalidateTokens(),this.rejectPromise(j,c,{},"Cannot validate token; no token found.");return c.promise()},n.prototype.emailSignUp=function(a){a||(a={});var c=this.getConfig(a.config),d=this.getApiUrl()+c.emailRegistrationPath,e=b.Deferred();return a.config_name=a.config,delete a.config,a.confirm_success_url=c.confirmationSuccessUrl(),b.ajax({url:d,context:this,method:"POST",data:a,success:function(a){this.resolvePromise("auth.emailRegistration.success",e,a)},error:function(a){this.rejectPromise("auth.emailRegistration.error",e,a,"Failed to submit email registration.")}}),e.promise()},n.prototype.emailSignIn=function(a){a||(a={});var c=this.getConfig(a.config),d=this.getApiUrl()+c.emailSignInPath,e=b.Deferred();return delete a.config,b.ajax({url:d,context:this,method:"POST",data:a,success:function(a){var b=c.handleLoginResponse(a);this.setCurrentUser(b),this.resolvePromise("auth.emailSignIn.success",e,a),this.broadcastEvent(l,b),this.broadcastEvent(i,this.user)},error:function(a){this.rejectPromise("auth.emailSignIn.error",e,a,"Invalid credentials."),this.broadcastEvent(m,a)}}),e.promise()},n.prototype.listenForCredentials=function(a){if(a.closed)this.rejectPromise(k,this.oAuthDfd,null,"OAuth window was closed bofore registration was completed.");else{var b=this;a.postMessage("requestCredentials","*"),this.oAuthTimer=setTimeout(function(){b.listenForCredentials(a)},500)}},n.prototype.openAuthWindow=function(b){if(this.getConfig().forceHardRedirect||a.isIE())this.setLocation(b);else{var c=this.createPopup(b);this.listenForCredentials(c)}},n.prototype.buildOAuthUrl=function(b,c,d){var e=this.getConfig().apiUrl+d+"?auth_origin_url="+encodeURIComponent(a.location.href)+"&config_name="+encodeURIComponent(b||this.getCurrentConfigName());if(c)for(var f in c)e+="&",e+=encodeURIComponent(f),e+="=",e+=encodeURIComponent(c[f]);return e},n.prototype.oAuthSignIn=function(a){if(a||(a={}),!a.provider)throw"jToker: provider param undefined for `oAuthSignIn` method.";var c=this.getConfig(a.config),d=c.authProviderPaths[a.provider],e=this.buildOAuthUrl(a.config,a.params,d);if(!d)throw"jToker: providerPath not found for provider: "+a.provider;return this.oAuthDfd=b.Deferred(),this.openAuthWindow(e),this.oAuthDfd.promise()},n.prototype.signOut=function(a){a||(a={});var c=this.getConfig(a.config),d=this.getApiUrl()+c.signOutPath,e=b.Deferred();return b.ajax({url:d,context:this,method:"DELETE",success:function(a){this.resolvePromise("auth.signOut.success",e,a)},error:function(a){this.rejectPromise("auth.signOut.error",e,a,"Failed to sign out.")},complete:function(){this.invalidateTokens()}}),e.promise()},n.prototype.updateAccount=function(a){a||(a={});var c=this.getConfig(a.config),d=this.getApiUrl()+c.accountUpdatePath,e=b.Deferred();return delete a.config,b.ajax({url:d,context:this,method:"PUT",data:a,success:function(a){var b=c.handleAccountUpdateResponse(a);this.setCurrentUser(b),this.resolvePromise("auth.accountUpdate.success",e,a)},error:function(a){this.rejectPromise("auth.accountUpdate.error",e,a,"Failed to update user account")}}),e.promise()},n.prototype.destroyAccount=function(a){a||(a={});var c=this.getConfig(a.config),d=this.getApiUrl()+c.accountDeletePath,e=b.Deferred();return b.ajax({url:d,context:this,method:"DELETE",success:function(a){this.invalidateTokens(),this.resolvePromise("auth.destroyAccount.success",e,a)},error:function(a){this.rejectPromise("auth.destroyAccount.error",e,a,"Failed to destroy user account")}}),e.promise()},n.prototype.requestPasswordReset=function(a){if(a||(a={}),void 0===a.email)throw"jToker: email param undefined for `requestPasswordReset` method.";var c=this.getConfig(a.config),d=this.getApiUrl()+c.passwordResetPath,e=b.Deferred();return a.config_name=a.config,delete a.config,a.redirect_url=c.passwordResetSuccessUrl(),b.ajax({url:d,context:this,method:"POST",data:a,success:function(a){this.resolvePromise("auth.passwordResetRequest.success",e,a)},error:function(a){this.rejectPromise("auth.passwordResetRequest.error",e,a,"Failed to submit email registration.")}}),e.promise()},n.prototype.updatePassword=function(a){a||(a={});var c=this.getConfig(a.config),d=this.getApiUrl()+c.passwordUpdatePath,e=b.Deferred();return delete a.config,b.ajax({url:d,context:this,method:"PUT",data:a,success:function(a){this.resolvePromise("auth.passwordUpdate.success",e,a)},error:function(a){this.rejectPromise("auth.passwordUpdate.error",e,a,"Failed to update password.")}}),e.promise()},n.prototype.persistData=function(c,d,e){switch(d=JSON.stringify(d),this.getConfig(e).storage){case"cookies":b.cookie(c,d,{expires:this.getConfig(e).cookieExpiry,path:this.getConfig(e).cookiePath});break;default:a.localStorage.setItem(c,d)}},n.prototype.retrieveData=function(c){var d=null;switch(this.getConfig().storage){case"cookies":d=b.cookie(c);break;default:d=a.localStorage.getItem(c)}try{return b.parseJSON(d)}catch(a){return p(d)}},n.prototype.getCurrentConfigName=function(){var c=null;return this.getQs().config&&(c=this.getQs().config),b.cookie&&!c&&(c=b.cookie(g)),a.localStorage&&!c&&(c=a.localStorage.getItem(g)),c=c||this.defaultConfigKey||f,p(c)},n.prototype.deleteData=function(c){switch(this.getConfig().storage){case"cookies":b.removeCookie(c,{path:this.getConfig().cookiePath});break;default:a.localStorage.removeItem(c)}},n.prototype.getConfig=function(a){if(!this.configured)throw"jToker: `configure` must be run before using this plugin.";return a=a||this.getCurrentConfigName(),this.configs[a]},n.prototype.appendAuthHeaders=function(b,c){var d=a.auth.retrieveData(h);if(q(c.url)&&d){b.setRequestHeader("If-Modified-Since","Mon, 26 Jul 1997 05:00:00 GMT");for(var e in a.auth.getConfig().tokenFormat)b.setRequestHeader(e,d[e])}},n.prototype.updateAuthCredentials=function(b,c,d){if(q(d.url)){var e={},f=!0;for(var g in a.auth.getConfig().tokenFormat)e[g]=c.getResponseHeader(g),e[g]&&(f=!1);f||a.auth.persistData(h,e)}},n.prototype.getRawSearch=function(){return a.location.search},n.prototype.getRawAnchor=function(){return a.location.hash},n.prototype.setRawAnchor=function(b){a.location.hash=b},n.prototype.getAnchorSearch=function(){var a=this.getRawAnchor().split("?");return a.length>1?a[1]:null},n.prototype.setRawSearch=function(b){a.location.search=b},n.prototype.setSearchQs=function(a){return this.setRawSearch(b.param(a)),this.getSearchQs()},n.prototype.setAnchorQs=function(a){return this.setAnchorSearch(b.param(a)),this.getAnchorQs()},n.prototype.setLocation=function(b){a.location.replace(b)},n.prototype.createPopup=function(b){return a.open(b)},n.prototype.getSearchQs=function(){var a=this.getRawSearch().replace("?","");return a?c(a):{}},n.prototype.getAnchorQs=function(){var a=this.getAnchorSearch();return a?c(a):{}},n.prototype.getQs=function(){return b.extend(this.getSearchQs(),this.getAnchorQs())};var o=function(a){for(var b in a)return b},p=function(a){return a&&a.replace(/("|')/g,"")},q=function(b){return b.match(a.auth.getApiUrl())},r=function(a,b){for(var c=function(a,c){return void 0===b[c]?a:b[c]},d=new RegExp("{{\\s*([a-z0-9-_]+)\\s*}}","ig"),e="";e!==a;a=(e=a).replace(d,c));return a};return a.isOldIE=function(){var a=!1,b=e.userAgent.toLowerCase();if(b&&-1!==b.indexOf("msie")){parseInt(b.split("msie")[1])<10&&(a=!0)}return a},a.isIE=function(){var b=a.isOldIE(),c=!!e.userAgent.match(/Trident.*rv\:11\./);return b||c},a.auth=b.auth=new n,a.auth});